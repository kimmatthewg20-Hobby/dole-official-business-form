<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Employee Management</title>
  <link rel="icon" type="image/png" href="logo.png">
  <link rel="shortcut icon" type="image/png" href="logo.png">
  <link rel="apple-touch-icon" href="logo.png">
  <style>
    :root {
      --primary-color: #004d40;
      --primary-light: #39796b;
      --secondary-color: #00897b;
      --accent-color: #4db6ac;
      --light-color: #ffffff;
      --border-color: #ddd;
      --text-color: #333;
      --danger-color: #d32f2f;
      --success-color: #388e3c;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: Arial, sans-serif;
      line-height: 1.6;
      background-color: #f5f5f5;
      color: var(--text-color);
    }
    
    header {
      background-color: var(--primary-color);
      color: var(--light-color);
      padding: 10px 0;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      width: 100%;
      position: relative;
    }
    
    .container {
      width: 90%;
      max-width: 1200px;
      margin: 0 auto;
      padding: 15px;
    }
    
    h1, h2 {
      margin: 0;
    }
    
    .header-content {
      display: flex;
      justify-content: flex-start;
      align-items: center;
      width: 100%;
      position: relative;
    }
    
    .logo-container {
      display: flex;
      align-items: center;
      gap: 15px;
      position: relative;
      left: 0;
      min-width: 400px;
      transition: none;
      white-space: nowrap;
    }
    
    .logo {
      max-width: 60px;
      height: auto;
    }
    
    .logo-container h1 {
      white-space: nowrap;
    }
    
    .btn {
      background-color: var(--primary-color);
      color: var(--light-color);
      border: none;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 5px;
      transition: background-color 0.3s;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .btn:hover {
      background-color: var(--primary-light);
    }
    
    .btn-danger {
      background-color: var(--danger-color);
    }
    
    .btn-danger:hover {
      background-color: #b71c1c;
    }
    
    .top-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .search-container {
      display: flex;
      align-items: center;
      flex: 1;
      max-width: 400px;
    }
    
    .search-input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-size: 14px;
    }
    
    .employee-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      background-color: white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .employee-table th {
      background-color: var(--primary-color);
      color: white;
      padding: 12px;
      text-align: left;
    }
    
    .employee-table td {
      padding: 12px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .employee-table tr:hover {
      background-color: #f9f9f9;
    }
    
    .action-btn {
      margin-right: 5px;
      background-color: transparent;
      border: none;
      cursor: pointer;
      font-size: 16px;
    }
    
    .history-btn {
      color: var(--primary-color);
    }
    
    .edit-btn {
      color: var(--secondary-color);
    }
    
    .delete-btn {
      color: var(--danger-color);
    }
    
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    
    .modal {
      background-color: white;
      border-radius: 5px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    
    .modal-header {
      padding: 15px;
      border-bottom: 1px solid #dee2e6;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-body {
      padding: 15px;
    }
    
    .modal-footer {
      padding: 15px;
      border-top: 1px solid #dee2e6;
      text-align: right;
    }
    
    .close-modal {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #666;
      padding: 0;
      margin: 0;
      line-height: 1;
    }
    
    .close-modal:hover {
      color: #000;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    
    .form-group input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    .history-list {
      list-style: none;
      padding: 0;
    }

    .history-item {
      padding: 10px;
      border-bottom: 1px solid #ddd;
    }

    .history-item:last-child {
      border-bottom: none;
    }

    .history-date {
      font-weight: bold;
    }

    .error-message, .success-message {
      padding: 10px;
      margin-bottom: 15px;
      border-radius: 4px;
    }

    .error-message {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .success-message {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    /* Summary Modal Styles */
    .data-summary-content {
      margin: 0 15px 20px 15px;
      padding: 10px 0;
    }
    
    .summary-item {
      margin-bottom: 10px;
      padding-bottom: 5px;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .summary-item strong {
      display: inline-block;
      width: 120px;
      color: var(--primary-color);
    }

    /* Sidebar Styles */
    .sidebar {
      height: 100%;
      width: 0;
      position: fixed;
      z-index: 1100;
      top: 0;
      left: 0;
      background-color: var(--primary-color);
      overflow-x: hidden;
      transition: 0.3s;
      padding-top: 60px;
      box-shadow: 2px 0 5px rgba(0,0,0,0.2);
    }

    .sidebar.active {
      width: 250px;
    }

    .sidebar a {
      padding: 8px 8px 8px 32px;
      text-decoration: none;
      font-size: 18px;
      color: white;
      display: block;
      transition: 0.3s;
    }

    .sidebar a:hover {
      background-color: var(--primary-light);
    }

    /* Add these new styles for icon and text alignment */
    .sidebar a i {
      margin-right: 15px;
      vertical-align: middle;
    }
    
    .sidebar a {
      display: flex;
      align-items: center;
    }

    .sidebar .close-btn {
      position: absolute;
      top: 15px;
      right: 20px;
      font-size: 36px;
      margin-left: 50px;
      color: white;
      background: none;
      border: none;
      cursor: pointer;
    }

    .hamburger-menu {
      font-size: 30px;
      cursor: pointer;
      border: none;
      background: none;
      color: white;
      margin-right: 15px;
      z-index: 1000;
      position: relative;
      pointer-events: auto;
      display: block !important;
      visibility: visible !important;
    }

    #main {
      transition: margin-left .5s;
      padding: 16px;
    }

    @media screen and (max-height: 450px) {
      .sidebar {padding-top: 15px;}
      .sidebar a {font-size: 18px;}
    }

    /* Material Icons */
    .material-icons {
      font-family: 'Material Icons';
      font-weight: normal;
      font-style: normal;
      font-size: 24px;
      line-height: 1;
      letter-spacing: normal;
      text-transform: none;
      display: inline-block;
      white-space: nowrap;
      word-wrap: normal;
      direction: ltr;
      -webkit-font-feature-settings: 'liga';
      -webkit-font-smoothing: antialiased;
    }

    .action-col {
      text-align: center;
      min-width: 150px;
    }

    /* Pagination styles */
    .pagination {
      display: flex;
      justify-content: center;
      margin-top: 20px;
      gap: 5px;
    }
    
    .pagination-btn {
      padding: 5px 10px;
      border: 1px solid var(--border-color);
      background-color: #f5f5f5;
      cursor: pointer;
      border-radius: 3px;
    }
    
    .pagination-btn.active {
      background-color: var(--primary-color);
      color: var(--light-color);
      border-color: var(--primary-color);
    }
    
    .pagination-btn:hover:not(.active) {
      background-color: #e0e0e0;
    }

    /* Footer styles */
    .site-footer {
      padding: 15px 0;
      margin-top: 30px;
    }
    
    .site-footer p {
      font-family: 'Courier New', Courier, monospace;
      color: #cccccc;
      font-size: 14px;
      margin: 0;
      text-align: center;
    }
  </style>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>
<body>
  <!-- Sidebar -->
  <div id="sidebar" class="sidebar">
    <button class="close-btn">&times;</button>
    <a href="index.html">
      <i class="material-icons">home</i> Home
    </a>
    <a href="employees.html" class="active">
      <i class="material-icons">people</i> Employees
    </a>
  </div>

  <header>
    <div class="container">
      <div class="header-content">
        <div class="logo-container">
          <button class="hamburger-menu">&#9776;</button>
          <img src="logo.png" alt="DOLE Logo" class="logo">
          <h1>Employee Management</h1>
        </div>
      </div>
    </div>
  </header>

  <div id="main" class="container">
    <div id="alert-container"></div>
    
    <div class="top-actions">
      <div class="search-container">
        <input type="text" id="searchInput" class="search-input" placeholder="Search by name, position, or unit...">
      </div>
      <button id="addEmployeeBtn" class="btn">
        <i class="material-icons">add</i> Add Employee
      </button>
    </div>
    
    <table class="employee-table">
      <thead>
        <tr>
          <th>Full Name</th>
          <th>Position</th>
          <th>Assigned Unit</th>
          <th class="action-col">Actions</th>
        </tr>
      </thead>
      <tbody id="employeeTableBody">
        <!-- Employee data will be loaded here -->
      </tbody>
    </table>
    
    <div id="pagination" class="pagination">
      <!-- Pagination controls will be added here -->
    </div>
  </div>
  
  <!-- Add/Edit Employee Modal -->
  <div id="employeeModal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h3 id="modalTitle">Add Employee</h3>
        <button class="close-modal" onclick="closeModal('employeeModal')">&times;</button>
      </div>
      <div class="modal-body">
        <form id="employeeForm">
          <input type="hidden" id="employeeId">
          <div class="form-group">
            <label for="employeeIdInput">Employee ID</label>
            <input type="text" id="employeeIdInput" required>
          </div>
          <div class="form-group">
            <label for="firstname">First Name</label>
            <input type="text" id="firstname" required>
          </div>
          <div class="form-group">
            <label for="middleName">Middle Name</label>
            <input type="text" id="middleName">
          </div>
          <div class="form-group">
            <label for="lastName">Last Name</label>
            <input type="text" id="lastName" required>
          </div>
          <div class="form-group">
            <label for="position">Position</label>
            <input type="text" id="position" required>
          </div>
          <div class="form-group">
            <label for="assignedUnit">Assigned Unit</label>
            <input type="text" id="assignedUnit" required>
          </div>
        </form>
      </div>
      <div class="modal-footer" style="display: flex; justify-content: flex-end; gap: 10px;">
        <button type="button" class="btn btn-danger" data-modal="employeeModal">Cancel</button>
        <button type="button" id="saveEmployeeBtn" class="btn">Save</button>
      </div>
    </div>
  </div>
  
  <!-- History Modal -->
  <div id="historyModal" class="modal-overlay">
    <div class="modal" style="width: 80%; max-width: 1000px;">
      <div class="modal-header">
        <h3 class="modal-title">Employee Travel History</h3>
        <button class="close-modal" onclick="closeModal('historyModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="table-responsive" style="display: flex; justify-content: center;">
          <table class="table" style="width: 100%; text-align: center;">
            <thead>
              <tr>
                <th>Travel ID</th>
                <th>Date of OB</th>
                <th>Location</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="historyTableBody">
              <!-- Travel history will be loaded here -->
            </tbody>
          </table>
        </div>
        <p id="historyEmptyMessage" style="text-align: center; display: none;">No travel history found.</p>
      </div>
      <div class="modal-footer" style="display: flex; justify-content: flex-end;">
        <button type="button" class="btn btn-danger" onclick="closeModal('historyModal')">Close</button>
      </div>
    </div>
  </div>
  
  <!-- Summary Modal -->
  <div id="summaryModal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Travel Request Summary</h3>
        <button class="close-modal" onclick="closeModal('summaryModal')">&times;</button>
      </div>
      <div class="data-summary-content">
        <div class="summary-item">
          <strong>Travel ID:</strong>
          <span id="summaryTravelId"></span>
        </div>
        <div class="summary-item">
          <strong>Office:</strong>
          <span id="summaryOffice"></span>
        </div>
        <div class="summary-item">
          <strong>Division:</strong>
          <span id="summaryDivision"></span>
        </div>
        <div class="summary-item">
          <strong>Date:</strong>
          <span id="summaryDate"></span>
        </div>
        <div class="summary-item">
          <strong>From:</strong>
          <span id="summaryFrom"></span>
        </div>
        <div class="summary-item">
          <strong>To:</strong>
          <span id="summaryTo"></span>
        </div>
        <div class="summary-item">
          <strong>Time:</strong>
          <span id="summaryTime"></span>
        </div>
        <div class="summary-item">
          <strong>Purpose:</strong>
          <span id="summaryPurpose"></span>
        </div>
        <div class="summary-item">
          <strong>Signed Date:</strong>
          <span id="summarySignedDate"></span>
        </div>
        <div class="summary-item">
          <strong>Released Date:</strong>
          <span id="summaryReleasedDate"></span>
        </div>
        <div class="summary-item">
          <strong>Released To:</strong>
          <span id="summaryReleasedTo"></span>
        </div>
        <div class="summary-item">
          <strong>Employees:</strong>
          <div id="summaryEmployees"></div>
        </div>
      </div>
      <div class="modal-footer" style="display: flex; justify-content: flex-end; gap: 10px;">
        <button type="button" class="btn btn-danger" onclick="closeModal('summaryModal')">Close</button>
        <button type="button" id="generateFormBtn" class="btn btn-primary">Generate Form</button>
      </div>
    </div>
  </div>
  
  <!-- Delete Confirmation Modal -->
  <div id="deleteModal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h3>Confirm Delete</h3>
        <button class="close-modal" onclick="closeModal('deleteModal')">&times;</button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete this employee?</p>
        <p id="deleteEmployeeName" style="font-weight: bold;"></p>
        <input type="hidden" id="deleteEmployeeId">
      </div>
      <div class="modal-footer" style="display: flex; justify-content: flex-end; gap: 10px;">
        <button type="button" class="btn" data-modal="deleteModal">Cancel</button>
        <button type="button" id="confirmDeleteBtn" class="btn btn-danger">Delete</button>
      </div>
    </div>
  </div>
  
  <script>
    // Add these functions at the global scope
    function openModal(modalId) {
      document.getElementById(modalId).style.display = 'flex';
    }
    
    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
    }

    document.addEventListener('DOMContentLoaded', function() {
      // DOM elements
      const searchInput = document.getElementById('searchInput');
      const employeeTableBody = document.getElementById('employeeTableBody');
      const addEmployeeBtn = document.getElementById('addEmployeeBtn');
      const employeeForm = document.getElementById('employeeForm');
      const saveEmployeeBtn = document.getElementById('saveEmployeeBtn');
      const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
      const modalTitle = document.getElementById('modalTitle');
      const paginationContainer = document.getElementById('pagination');
      
      // State variables
      let currentPage = 1;
      const itemsPerPage = 10;
      let totalPages = 1;
      let employeesData = [];
      
      // Initialize by loading employees
      loadEmployees();
      
      // Initialize employees data if needed
      initializeEmployeesData();
      
      // Event listeners
      searchInput.addEventListener('input', function() {
        loadEmployees(searchInput.value);
      });
      
      addEmployeeBtn.addEventListener('click', function() {
        openAddEmployeeModal();
      });
      
      saveEmployeeBtn.addEventListener('click', function() {
        saveEmployee();
      });
      
      confirmDeleteBtn.addEventListener('click', function() {
        const employeeId = document.getElementById('deleteEmployeeId').value;
        deleteEmployee(employeeId);
      });
      
      // Setup view form button in the summary modal
      try {
        const viewFormBtn = document.getElementById('viewFormBtn');
        if (viewFormBtn) {
          viewFormBtn.addEventListener('click', function() {
            const travelId = document.getElementById('summaryTravelId').textContent;
            if (travelId) {
              window.open(`/print/${travelId}`, '_blank');
            }
          });
        }
      } catch (e) {
        console.warn('viewFormBtn not found', e);
      }
      
      // Setup generate form button in the summary modal
      document.getElementById('generateFormBtn').addEventListener('click', function() {
        const travelId = document.getElementById('summaryTravelId').textContent;
        if (travelId && travelId !== 'N/A') {
          window.open(`/print/${travelId}`, '_blank');
        } else {
          showAlert('Invalid travel ID', 'error');
        }
      });
      
      // Functions
      function loadEmployees(searchQuery = '') {
        fetch(`/api/employees?search=${encodeURIComponent(searchQuery)}`)
          .then(response => {
            if (!response.ok) {
              throw new Error('Failed to load employees');
            }
            return response.json();
          })
          .then(data => {
            employeesData = data.employees || [];
            renderEmployeeTable();
            setupPagination();
          })
          .catch(error => {
            showAlert(error.message, 'error');
          });
      }
      
      function renderEmployeeTable() {
        employeeTableBody.innerHTML = '';
        
        // Calculate pagination
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = Math.min(startIndex + itemsPerPage, employeesData.length);
        const paginatedData = employeesData.slice(startIndex, endIndex);
        
        if (paginatedData.length === 0) {
          const row = document.createElement('tr');
          row.innerHTML = '<td colspan="4" style="text-align: center;">No employees found</td>';
          employeeTableBody.appendChild(row);
          return;
        }
        
        paginatedData.forEach(employee => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${employee.full_name}</td>
            <td>${employee.position}</td>
            <td>${employee.assigned_unit}</td>
            <td class="action-col">
              <button class="action-btn history-btn" title="View History" data-id="${employee.id}">
                <i class="material-icons">history</i>
              </button>
              <button class="action-btn edit-btn" title="Edit" data-id="${employee.id}">
                <i class="material-icons">edit</i>
              </button>
              <button class="action-btn delete-btn" title="Delete" data-id="${employee.id}">
                <i class="material-icons">delete</i>
              </button>
            </td>
          `;
          employeeTableBody.appendChild(row);
        });
        
        // Add event listeners to action buttons
        document.querySelectorAll('.history-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const employeeId = this.getAttribute('data-id');
            viewHistory(employeeId, employeesData.find(e => e.id === employeeId)?.full_name || '');
          });
        });
        
        document.querySelectorAll('.edit-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const employeeId = this.getAttribute('data-id');
            editEmployee(employeeId);
          });
        });
        
        document.querySelectorAll('.delete-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const employeeId = this.getAttribute('data-id');
            confirmDelete(employeeId);
          });
        });
      }
      
      function setupPagination() {
        paginationContainer.innerHTML = '';
        
        // Calculate total pages
        totalPages = Math.ceil(employeesData.length / itemsPerPage);
        
        if (totalPages <= 1) {
          return;
        }
        
        // Previous button
        const prevBtn = document.createElement('button');
        prevBtn.classList.add('pagination-btn');
        prevBtn.textContent = '«';
        prevBtn.disabled = currentPage === 1;
        prevBtn.addEventListener('click', () => {
          if (currentPage > 1) {
            currentPage--;
            renderEmployeeTable();
            setupPagination();
          }
        });
        paginationContainer.appendChild(prevBtn);
        
        // Page buttons
        const startPage = Math.max(1, currentPage - 2);
        const endPage = Math.min(totalPages, startPage + 4);
        
        for (let i = startPage; i <= endPage; i++) {
          const pageBtn = document.createElement('button');
          pageBtn.classList.add('pagination-btn');
          if (i === currentPage) {
            pageBtn.classList.add('active');
          }
          pageBtn.textContent = i;
          pageBtn.addEventListener('click', () => {
            currentPage = i;
            renderEmployeeTable();
            setupPagination();
          });
          paginationContainer.appendChild(pageBtn);
        }
        
        // Next button
        const nextBtn = document.createElement('button');
        nextBtn.classList.add('pagination-btn');
        nextBtn.textContent = '»';
        nextBtn.disabled = currentPage === totalPages;
        nextBtn.addEventListener('click', () => {
          if (currentPage < totalPages) {
            currentPage++;
            renderEmployeeTable();
            setupPagination();
          }
        });
        paginationContainer.appendChild(nextBtn);
      }
      
      function openAddEmployeeModal() {
        // Clear the form
        document.getElementById('employeeId').value = '';
        document.getElementById('employeeIdInput').value = '';
        document.getElementById('firstname').value = '';
        document.getElementById('middleName').value = '';
        document.getElementById('lastName').value = '';
        document.getElementById('position').value = '';
        document.getElementById('assignedUnit').value = '';
        
        // Set modal title
        modalTitle.textContent = 'Add Employee';
        
        // Show the modal
        openModal('employeeModal');
      }
      
      function editEmployee(employeeId) {
        // Find the employee
        const employee = employeesData.find(emp => emp.id == employeeId);
        
        if (!employee) {
          showAlert('Employee not found', 'error');
          return;
        }
        
        // Populate the form
        document.getElementById('employeeId').value = employee.id;
        document.getElementById('employeeIdInput').value = employee.employee_id || '';
        document.getElementById('firstname').value = employee.firstname || '';
        document.getElementById('middleName').value = employee.middle_name || '';
        document.getElementById('lastName').value = employee.last_name || '';
        document.getElementById('position').value = employee.position || '';
        document.getElementById('assignedUnit').value = employee.assigned_unit || '';
        
        // Set modal title
        modalTitle.textContent = 'Edit Employee';
        
        // Show the modal
        openModal('employeeModal');
      }
      
      function saveEmployee() {
        // Get form values
        const employeeId = document.getElementById('employeeId').value;
        const employee_id = document.getElementById('employeeIdInput').value;
        const firstname = document.getElementById('firstname').value;
        const middle_name = document.getElementById('middleName').value;
        const last_name = document.getElementById('lastName').value;
        const position = document.getElementById('position').value;
        const assigned_unit = document.getElementById('assignedUnit').value;
        
        // Validate required fields
        if (!firstname || !last_name || !position || !assigned_unit) {
          showAlert('Please fill all required fields', 'error');
          return;
        }
        
        // Create employee object
        const employeeData = {
          employee_id,
          firstname,
          middle_name,
          last_name,
          position,
          assigned_unit
        };
        
        // Determine if this is an add or edit operation
        const isEdit = employeeId !== '';
        const url = isEdit ? `/api/employees/${employeeId}` : '/api/employees';
        const method = isEdit ? 'PUT' : 'POST';
        
        // Send request to server
        fetch(url, {
          method: method,
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(employeeData)
        })
          .then(response => {
            if (!response.ok) {
              return response.json().then(data => {
                throw new Error(data.error || 'Failed to save employee');
              });
            }
            return response.json();
          })
          .then(data => {
            // Close the modal
            closeModal('employeeModal');
            
            // Show success message
            showAlert(data.message || 'Employee saved successfully', 'success');
            
            // Reload employees
            loadEmployees();
          })
          .catch(error => {
            showAlert(error.message, 'error');
          });
      }
      
      function confirmDelete(employeeId) {
        // Find the employee
        const employee = employeesData.find(emp => emp.id == employeeId);
        
        if (!employee) {
          showAlert('Employee not found', 'error');
          return;
        }
        
        // Set employee name in modal
        document.getElementById('deleteEmployeeName').textContent = employee.full_name;
        document.getElementById('deleteEmployeeId').value = employeeId;
        
        // Show the modal
        openModal('deleteModal');
      }
      
      function deleteEmployee(employeeId) {
        fetch(`/api/employees/${employeeId}`, {
          method: 'DELETE'
        })
          .then(response => {
            if (!response.ok) {
              return response.json().then(data => {
                throw new Error(data.error || 'Failed to delete employee');
              });
            }
            return response.json();
          })
          .then(data => {
            // Close the modal
            closeModal('deleteModal');
            
            // Show success message
            showAlert(data.message || 'Employee deleted successfully', 'success');
            
            // Reload employees
            loadEmployees();
          })
          .catch(error => {
            showAlert(error.message, 'error');
          });
      }
      
      function viewHistory(employeeId, employeeName) {
        console.log(`Fetching history for employee ID: ${employeeId}`);
        
        // Show loading message
        const historyTable = document.getElementById('historyTableBody');
        const emptyMessage = document.getElementById('historyEmptyMessage');
        historyTable.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px;">Loading travel history...</td></tr>';
        historyTable.style.display = '';
        emptyMessage.style.display = 'none';
        
        // Open the modal first to show loading state
        openModal('historyModal');
        
        fetch(`/api/employees/${employeeId}/history`)
          .then(response => {
            if (!response.ok) {
              throw new Error('Failed to load travel history');
            }
            return response.json();
          })
          .then(data => {
            console.log('Travel history data:', data);
            
            historyTable.innerHTML = '';
            
            // Check if there's no history data at all
            if (!data.history || data.history.length === 0) {
              historyTable.style.display = 'none';
              emptyMessage.style.display = 'block';
              emptyMessage.textContent = `No travel history found for ${employeeName || 'this employee'}.`;
              return;
            }
            
            // Check specifically for fallback message in the response
            const hasFallbackMessage = data.message && (
              data.message.includes('Falling back') ||
              data.message.includes('all entries') ||
              data.message.includes('No history found')
            );
            
            // Only consider explicit fallback indicators
            const hasFallbackIndicator = data.isFallback === true || 
                                       data.fallback === true || 
                                       hasFallbackMessage;
            
            console.log('Fallback data detection:', {
              hasFallbackIndicator,
              hasFallbackMessage,
              message: data.message,
              isFallback: data.isFallback,
              fallback: data.fallback
            });
            
            // Only show "No history" message if we have a clear fallback indicator
            if (hasFallbackIndicator) {
              console.log('Detected explicit fallback data - showing no history message');
              historyTable.style.display = 'none';
              emptyMessage.style.display = 'block';
              emptyMessage.textContent = `No travel history found for ${employeeName || 'this employee'}.`;
              return;
            }
            
            // If we get here, this is legitimate employee history data
            let validEntries = data.history;
            
            // Always check if results are empty
            if (validEntries.length === 0) {
              historyTable.style.display = 'none';
              emptyMessage.style.display = 'block';
              emptyMessage.textContent = `No travel history found for ${employeeName || 'this employee'}.`;
              return;
            }
            
            historyTable.style.display = '';
            emptyMessage.style.display = 'none';
            
            validEntries.forEach(entry => {
              const row = document.createElement('tr');
              
              // Format date - Match database.html format
              let dateDisplay = 'N/A';
              
              // Helper function to clean date strings
              function cleanDateString(str) {
                if (typeof str === 'string') {
                  return str.replace(/^\["|"\]$/g, '').replace(/[\[\]"]/g, '');
                }
                return str;
              }
              
              console.log('Date data:', {
                entry_date: entry.date,
                entry_created_at: entry.created_at,
                formData: entry.formData
              });
              
              if (entry.formData) {
                if (entry.formData.datesOfOB && Array.isArray(entry.formData.datesOfOB) && entry.formData.datesOfOB.length > 0) {
                  // Clean the date string before formatting
                  const cleanDate = cleanDateString(entry.formData.datesOfOB[0]);
                  dateDisplay = formatDate(cleanDate);
                  if (entry.formData.datesOfOB.length > 1) {
                    dateDisplay += ` (+ ${entry.formData.datesOfOB.length - 1} more)`;
                  }
                } else if (entry.formData.dates_of_ob) {
                  dateDisplay = formatDate(cleanDateString(entry.formData.dates_of_ob));
                } else if (entry.formData.date) {
                  dateDisplay = formatDate(cleanDateString(entry.formData.date));
                } else if (entry.formData.dateOfOB) {
                  dateDisplay = formatDate(cleanDateString(entry.formData.dateOfOB));
                } else if (entry.formData.date_of_ob) {
                  dateDisplay = formatDate(cleanDateString(entry.formData.date_of_ob));
                }
              }
              
              // Fallback to entry properties if formData doesn't have date
              if (dateDisplay === 'N/A') {
                if (entry.date) {
                  dateDisplay = formatDate(cleanDateString(entry.date));
                } else if (entry.created_at) {
                  dateDisplay = formatDate(cleanDateString(entry.created_at));
                } else if (entry.dateOfOB) {
                  dateDisplay = formatDate(cleanDateString(entry.dateOfOB));
                } else if (entry.dates_of_ob) {
                  dateDisplay = formatDate(cleanDateString(entry.dates_of_ob));
                } else if (entry.date_of_ob) {
                  dateDisplay = formatDate(cleanDateString(entry.date_of_ob));
                } else if (entry.date_created) {
                  dateDisplay = formatDate(cleanDateString(entry.date_created));
                }
              }
              
              // Get location (to) - Match exact format from database.html
              let locationText = 'N/A';
              
              if (entry.formData) {
                if (entry.formData.location_to) {
                  locationText = entry.formData.location_to;
                } else if (entry.formData.to) {
                  locationText = entry.formData.to;
                } else if (entry.formData.locationTo) {
                  locationText = entry.formData.locationTo;
                } else if (entry.formData.location) {
                  locationText = entry.formData.location;
                }
              }
              
              // Fallback to entry properties if formData doesn't have location
              if (locationText === 'N/A') {
                if (entry.location_to) {
                  locationText = entry.location_to;
                } else if (entry.to) {
                  locationText = entry.to;
                } else if (entry.locationTo) {
                  locationText = entry.locationTo;
                } else if (entry.location) {
                  locationText = entry.location;
                }
              }
              
              // More robust travel ID extraction
              const travelId = entry.travel_id || entry.travelId || entry.id || 
                             (entry.formData && (entry.formData.travel_id || entry.formData.travelId || ''));
              
              row.innerHTML = `
                <td>${travelId || 'N/A'}</td>
                <td>${dateDisplay}</td>
                <td>${locationText}</td>
                <td>
                  <button class="btn view-details-btn" style="background-color: #004d40; color: white; padding: 6px 12px; display: inline-flex; align-items: center; justify-content: center; margin: 0 auto;" data-id="${travelId}">
                    <i class="material-icons" style="font-size: 18px; vertical-align: middle; margin-right: 5px;">visibility</i> View Details
                  </button>
                </td>
              `;
              
              historyTable.appendChild(row);
            });
            
            // Add event listeners for view details buttons
            document.querySelectorAll('.view-details-btn').forEach(btn => {
              btn.addEventListener('click', function() {
                const travelId = this.getAttribute('data-id');
                if (travelId) {
                  viewTravelDetails(travelId);
                } else {
                  showAlert('Invalid travel ID', 'error');
                }
              });
            });
          })
          .catch(error => {
            console.error('Error loading travel history:', error);
            historyTable.innerHTML = `<tr><td colspan="4" style="text-align: center; color: #d32f2f;">Error: ${error.message}</td></tr>`;
            showAlert('Failed to load travel history: ' + error.message, 'error');
          });
      }
      
      function viewTravelDetails(travelId) {
        if (!travelId || travelId === 'N/A') {
          showAlert('Invalid travel ID', 'error');
          return;
        }

        fetch(`/api/entries/${travelId}`)
          .then(response => {
            if (!response.ok) {
              if (response.status === 404) {
                throw new Error('Travel details not found');
              }
              throw new Error('Failed to load travel details');
            }
            return response.json();
          })
          .then(data => {
            // For debugging
            console.log('Travel details data:', data);
            console.log('Form data structure:', data.formData);
            
            // Helper function to clean date strings
            function cleanDateString(str) {
              if (typeof str === 'string') {
                return str.replace(/^\["|"\]$/g, '').replace(/[\[\]"]/g, '');
              }
              return str;
            }
            
            // Populate summary fields
            document.getElementById('summaryTravelId').textContent = data.formData?.travelId || data.travelId || data.formData?.travel_id || data.travel_id || travelId;
            document.getElementById('summaryOffice').textContent = data.formData?.office || '';
            document.getElementById('summaryDivision').textContent = data.formData?.division || '';
            
            // Format dates
            let dateDisplay = 'N/A';
            if (data.formData) {
              if (data.formData.datesOfOB && Array.isArray(data.formData.datesOfOB) && data.formData.datesOfOB.length > 0) {
                // If multiple dates, show all of them - clean each date
                dateDisplay = formatDates(data.formData.datesOfOB.map(d => cleanDateString(d)));
              } else if (data.formData.dates_of_ob) {
                dateDisplay = formatDate(cleanDateString(data.formData.dates_of_ob));
              } else if (data.formData.date) {
                dateDisplay = formatDate(cleanDateString(data.formData.date));
              }
            }
            
            if (dateDisplay === 'N/A' && (data.date || data.created_at)) {
              dateDisplay = formatDate(cleanDateString(data.date || data.created_at));
            }
            
            document.getElementById('summaryDate').textContent = dateDisplay;
            
            document.getElementById('summaryFrom').textContent = data.formData?.location_from || data.formData?.from || '';
            document.getElementById('summaryTo').textContent = data.formData?.location_to || data.formData?.to || '';
            
            // Format time
            let timeDisplay = '';
            if (data.formData?.departure_time || data.formData?.return_time) {
              timeDisplay = `${data.formData.departure_time || ''} - ${data.formData.return_time || ''}`;
            } else if (data.formData?.time) {
              timeDisplay = data.formData.time;
            }
            document.getElementById('summaryTime').textContent = timeDisplay;
            
            document.getElementById('summaryPurpose').textContent = data.formData?.purpose || '';
            
            // Set signed date
            document.getElementById('summarySignedDate').textContent = data.signed_date ? formatDate(data.signed_date) : 'Not signed yet';
            
            // Set released info
            document.getElementById('summaryReleasedDate').textContent = data.released_date ? formatDate(data.released_date) : 'Not released yet';
            document.getElementById('summaryReleasedTo').textContent = data.released_to || 'N/A';
            
            // Display employees
            const summaryEmployees = document.getElementById('summaryEmployees');
            summaryEmployees.innerHTML = '';
            
            // Check both places where employees might be stored
            let employees = data.employees || data.formData?.employees || [];
            
            if (employees && employees.length > 0) {
              employees.forEach(employee => {
                const employeeDiv = document.createElement('div');
                employeeDiv.textContent = `${employee.name || employee.full_name} (${employee.position})`;
                summaryEmployees.appendChild(employeeDiv);
              });
            } else {
              summaryEmployees.textContent = 'No employees listed';
            }
            
            // Show the summary modal
            closeModal('historyModal');
            openModal('summaryModal');
          })
          .catch(error => {
            console.error('Error loading travel details:', error);
            showAlert('Failed to load travel details: ' + error.message, 'error');
          });
      }
      
      function formatDate(dateString) {
        if (!dateString) return 'N/A';
        
        try {
          // Clean up the date string if it has square brackets and quotes
          if (typeof dateString === 'string') {
            // Remove square brackets and quotes
            dateString = dateString.replace(/^\["|"\]$/g, '');
            dateString = dateString.replace(/[\[\]"]/g, '');
          }
          
          const date = new Date(dateString);
          // Check if the date is valid
          if (isNaN(date.getTime())) {
            return dateString;
          }
          
          return date.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
          });
        } catch (e) {
          return dateString;
        }
      }
      
      function formatDates(dates) {
        if (!dates || !Array.isArray(dates)) return '';
        
        return dates.map(d => formatDate(d)).join(', ');
      }
      
      function showAlert(message, type) {
        const alertContainer = document.getElementById('alert-container');
        const alertDiv = document.createElement('div');
        
        alertDiv.className = type === 'error' ? 'error-message' : 'success-message';
        alertDiv.textContent = message;
        
        alertContainer.innerHTML = '';
        alertContainer.appendChild(alertDiv);
        
        // Auto hide after 5 seconds
        setTimeout(() => {
          alertDiv.remove();
        }, 5000);
      }
      
      function initializeEmployeesData() {
        // Check if we need to initialize the employees data
        fetch('/api/employees')
          .then(response => response.json())
          .then(data => {
            if (!data.employees || data.employees.length === 0) {
              // No employees found, initialize with data
              return fetch('/api/employees/initialize', {
                method: 'POST'
              });
            }
            return { json: () => ({ message: 'Employees already exist' }) };
          })
          .then(response => {
            if (response.json) {
              return response.json();
            }
            return response;
          })
          .then(data => {
            console.log(data.message);
            loadEmployees(); // Reload employees after initialization
          })
          .catch(error => {
            console.error('Error initializing employees:', error);
          });
      }
      
      // Add event listeners for all close buttons once the DOM is fully loaded
      document.querySelectorAll('.close-modal').forEach(button => {
        button.addEventListener('click', function() {
          const modal = this.closest('.modal-overlay');
          if (modal) {
            closeModal(modal.id);
          }
        });
      });

      // Fix the cancel buttons in modals
      document.querySelectorAll('.btn[data-modal]').forEach(button => {
        button.addEventListener('click', function() {
          const modalId = this.getAttribute('data-modal');
          if (modalId) {
            closeModal(modalId);
          }
        });
      });
    });
  </script>

  <!-- Include sidebar.js -->
  <script src="js/sidebar.js"></script>

  <!-- Footer -->
  <footer class="site-footer">
    <div class="container">
      <p>Kimmsg :3</p>
    </div>
  </footer>
</body>
</html> 