<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Official Business Form</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <style>
    :root {
      --primary-color: #004d40;
      --primary-light: #39796b;
      --secondary-color: #00897b;
      --accent-color: #4db6ac;
      --light-color: #ffffff;
      --border-color: #ddd;
      --text-color: #333;
      --danger-color: #d32f2f;
      --success-color: #388e3c;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: Arial, sans-serif;
      line-height: 1.6;
      background-color: #f5f5f5;
      color: var(--dark-color);
    }
    
    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 20px;
    }
    
    header {
      background-color: var(--primary-color);
      color: var(--light-color);
      padding: 15px 0;
      margin-bottom: 30px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    header .container {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .logo-container {
      display: flex;
      align-items: center;
    }
    
    .logo {
      width: 50px;
      height: auto;
      margin-right: 15px;
    }
    
    h1 {
      font-size: 24px;
    }
    
    .settings-btn {
      background-color: transparent;
      border: 1px solid var(--light-color);
      color: var(--light-color);
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    
    .settings-btn:hover {
      background-color: rgba(255,255,255,0.1);
    }
    
    .form-container {
      background-color: var(--light-color);
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .form-section {
      margin-bottom: 30px;
    }
    
    .form-section h2 {
      color: var(--primary-color);
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--primary-color);
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-row {
      display: flex;
      gap: 20px;
      margin-bottom: 15px;
    }
    
    .form-control {
      flex: 1;
    }
    
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    
    input, select, textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-size: 16px;
    }
    
    textarea {
      height: 120px;
      resize: vertical;
    }
    
    .btn {
      display: inline-block;
      background-color: var(--primary-color);
      color: var(--light-color);
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.3s;
    }
    
    .btn:hover {
      background-color: var(--secondary-color);
    }
    
    .btn-danger {
      background-color: var(--danger-color);
    }
    
    .btn-danger:hover {
      background-color: #b71c1c;
    }
    
    .btn-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    
    table th, table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }
    
    table th {
      background-color: var(--primary-color);
      color: var(--light-color);
    }
    
    table tr:nth-child(even) {
      background-color: #f2f2f2;
    }
    
    .empty-table-message {
      text-align: center;
      padding: 20px;
      font-style: italic;
      color: #777;
    }
    
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      visibility: hidden;
      opacity: 0;
      transition: visibility 0s linear 0.25s, opacity 0.25s;
    }
    
    .modal-overlay.active {
      visibility: visible;
      opacity: 1;
      transition-delay: 0s;
    }
    
    .modal {
      background-color: var(--light-color);
      width: 500px;
      max-width: 90%;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      padding: 20px;
      position: relative;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .modal-title {
      font-size: 20px;
      color: var(--primary-color);
    }
    
    .close-modal {
      background: transparent;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: #777;
    }
    
    .close-modal:hover {
      color: var(--danger-color);
    }
    
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
    }
    
    .alert {
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 4px;
      display: none;
    }
    
    .alert-success {
      background-color: #d4edda;
      color: var(--success-color);
      border: 1px solid #c3e6cb;
    }
    
    .alert-danger {
      background-color: #f8d7da;
      color: var(--danger-color);
      border: 1px solid #f5c6cb;
    }
    
    .alert.show {
      display: block;
    }
    
    .date-multi-select {
      min-height: 100px;
      overflow-y: auto;
    }
    
    .retrieve-form {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      align-items: flex-end;
    }
    
    .retrieve-form .form-control {
      flex: 2;
    }
    
    .retrieve-form .btn {
      flex: 1;
    }
    
    .success-modal .travel-id {
      font-weight: bold;
      color: var(--primary-color);
      font-size: 18px;
      text-align: center;
      margin: 20px 0;
    }

    .data-summary-content {
      margin: 15px 0;
    }

    .summary-item {
      margin-bottom: 10px;
      display: flex;
    }

    .summary-item strong {
      flex: 0 0 100px;
      color: var(--primary-color);
    }

    .summary-item span, .summary-item div {
      flex: 1;
    }

    #summaryEmployees div {
      margin-bottom: 5px;
    }

    @media print {
      .no-print {
        display: none;
      }
    }

    /* Database styles */
    .database-container {
      padding: 20px;
      max-height: 70vh;
      overflow-y: auto;
    }
    
    .database-controls {
      margin-bottom: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    #searchDatabase {
      padding: 8px 12px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      width: 250px;
    }
    
    .table-responsive {
      width: 100%;
      overflow-x: auto;
    }
    
    .table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    
    .table th, 
    .table td {
      padding: 10px;
      border: 1px solid var(--border-color);
      text-align: left;
    }
    
    .table th {
      background-color: var(--primary-color);
      color: var(--light-color);
      font-weight: bold;
    }
    
    .table tr:nth-child(even) {
      background-color: #f2f2f2;
    }
    
    .table tr:hover {
      background-color: #e6e6e6;
    }
    
    .btn-sm {
      padding: 4px 8px;
      font-size: 0.8rem;
      margin-right: 5px;
    }
    
    /* Error message styles */
    .error-message {
      color: var(--danger-color);
      font-size: 0.9rem;
      margin-top: 5px;
    }
    
    /* Modal body styles */
    .modal-body {
      padding: 15px;
    }

    /* Flatpickr styles */
    .flatpickr-calendar.open {
      z-index: 1100;
    }
    
    .flatpickr-day.selected {
      background: var(--primary-color);
      border-color: var(--primary-color);
    }
    
    /* Database modal styles for datepicker */
    #databaseModal .flatpickr-input[readonly] {
      background-color: white;
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="logo-container">
        <img src="logo.png" alt="DOLE Logo" class="logo">
        <h1>Official Business Form</h1>
      </div>
      <button id="settingsBtn" class="settings-btn">Settings</button>
    </div>
  </header>
  
  <div class="container">
    <div class="retrieve-form">
      <div class="form-control">
        <label for="retrieveId">Retrieve Travel ID</label>
        <input type="text" id="retrieveId" placeholder="Enter Travel ID (e.g., CNPO-JD-01-0001)">
      </div>
      <button id="retrieveBtn" class="btn">Retrieve</button>
    </div>
    
    <div id="alertContainer" class="alert"></div>
    
    <div class="form-container">
      <form id="obForm">
        <div class="form-section">
          <h2>Data Input Section</h2>
          <div class="form-row">
            <div class="form-control">
              <label for="office">Office</label>
              <input type="text" id="office" required>
            </div>
            <div class="form-control">
              <label for="division">Division</label>
              <select id="division" required>
                <option value="">Select Division</option>
              </select>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-control">
              <label for="dateOfOB">Date of Official Business</label>
              <input type="text" id="dateOfOB" required placeholder="Select date(s)">
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-control">
              <label for="locationFrom">From</label>
              <input type="text" id="locationFrom" required>
            </div>
            <div class="form-control">
              <label for="locationTo">To</label>
              <input type="text" id="locationTo" required>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-control">
              <label for="departureTime">Departure Time</label>
              <input type="time" id="departureTime" required>
            </div>
            <div class="form-control">
              <label for="returnTime">Return Time</label>
              <input type="time" id="returnTime" required>
            </div>
          </div>
          
          <div class="form-group">
            <label for="purpose">Purpose</label>
            <textarea id="purpose" required></textarea>
          </div>

          <div class="form-row">
            <div class="form-control">
              <label for="approvedBy">Approved By</label>
              <input type="text" id="approvedBy">
            </div>
            <div class="form-control">
              <label for="approvedByPosition">Position</label>
              <input type="text" id="approvedByPosition">
            </div>
          </div>
        </div>
        
        <div class="form-section">
          <h2>Employee Section</h2>
          <table id="employeeTable">
            <thead>
              <tr>
                <th>Name</th>
                <th>Position</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              <!-- Employee data will be inserted here dynamically -->
            </tbody>
          </table>
          <div id="emptyTableMessage" class="empty-table-message">No employees added yet.</div>
          
          <button type="button" id="addEmployeeBtn" class="btn">Add Employee</button>
        </div>
        
        <div class="btn-group">
          <button type="button" id="clearBtn" class="btn btn-danger">Clear Data</button>
          <button type="submit" id="submitBtn" class="btn">Submit</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Add Employee Modal -->
  <div id="addEmployeeModal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Add Employee</h3>
        <button class="close-modal">&times;</button>
      </div>
      <form id="employeeForm">
        <div class="form-group">
          <label for="employeeName">Name</label>
          <input type="text" id="employeeName" required>
        </div>
        <div class="form-group">
          <label for="employeePosition">Position</label>
          <input type="text" id="employeePosition" required>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger close-modal">Cancel</button>
          <button type="submit" class="btn">Add the Employee</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Settings Modal -->
  <div id="settingsModal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Settings</h3>
        <button class="close-modal">&times;</button>
      </div>
      <form id="settingsForm">
        <div class="form-group">
          <label for="defaultOffice">Default Office</label>
          <input type="text" id="defaultOffice" required>
        </div>
        <div class="form-group">
          <label for="defaultOfficeHead">Office Head (Approved by)</label>
          <input type="text" id="defaultOfficeHead" required>
        </div>
        <div class="form-group">
          <label for="defaultOfficeHeadPosition">Office Head Position</label>
          <input type="text" id="defaultOfficeHeadPosition" value="Provincial Head" required>
        </div>
        <div class="form-group">
          <label for="defaultFrom">Default From Location</label>
          <input type="text" id="defaultFrom" required>
        </div>
        <div class="form-group">
          <label for="divisionOptions">Division Options (comma-separated)</label>
          <textarea id="divisionOptions" required></textarea>
        </div>
        <div class="modal-footer">
          <button type="button" id="databaseBtn" class="btn btn-primary">Database</button>
          <button type="button" id="discardBtn" class="btn btn-danger">Discard</button>
          <button type="submit" class="btn">Apply</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Database Modal -->
  <div id="databaseModal" class="modal-overlay">
    <div class="modal" style="width: 90%; max-width: 1200px; max-height: 90vh; display: flex; flex-direction: column;">
      <div class="modal-header">
        <h3 class="modal-title">Database Management</h3>
        <button class="close-modal">&times;</button>
      </div>
      <div class="database-container" style="flex: 1; overflow-y: auto;">
        <div class="database-controls">
          <input type="text" id="searchDatabase" placeholder="Search...">
        </div>
        <div class="table-responsive">
          <table id="databaseTable" class="table">
            <thead>
              <tr>
                <th>Travel ID</th>
                <th>Date</th>
                <th>Name</th>
                <th>Position</th>
                <th>Division</th>
                <th>Destination</th>
                <th>Purpose</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="databaseTableBody">
              <!-- Data will be loaded here dynamically -->
            </tbody>
          </table>
        </div>
        <div class="pagination-container" style="display: flex; justify-content: space-between; align-items: center; margin: 15px 0;">
          <div class="pagination-info">
            Showing <span id="currentItemsShown">0</span> of <span id="totalItems">0</span> entries
          </div>
          <div class="pagination-controls">
            <button id="prevPageBtn" class="btn btn-sm btn-secondary" disabled>&laquo; Previous</button>
            <span id="paginationPages" style="margin: 0 10px;">Page <span id="currentPage">1</span> of <span id="totalPages">1</span></span>
            <button id="nextPageBtn" class="btn btn-sm btn-secondary" disabled>Next &raquo;</button>
          </div>
          <div class="items-per-page">
            <label for="itemsPerPage">Items per page:</label>
            <select id="itemsPerPage" class="form-control" style="display: inline-block; width: auto; margin-left: 5px;">
              <option value="10">10</option>
              <option value="25">25</option>
              <option value="50">50</option>
              <option value="100">100</option>
            </select>
          </div>
        </div>
        <div class="database-actions" style="margin-top: 20px; display: flex; justify-content: space-between;">
          <div>
            <button id="exportCSVBtn" class="btn btn-primary" style="margin-right: 10px;">Export to CSV</button>
            <button id="exportJSONBtn" class="btn btn-primary">Export to JSON</button>
          </div>
          <div>
            <label for="importJSONFile" class="btn btn-success" style="margin-right: 10px;">Import from JSON</label>
            <input type="file" id="importJSONFile" accept=".json" style="display: none;">
            <button id="deleteAllBtn" class="btn btn-danger">Delete All Data</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Password Modal -->
  <div id="passwordModal" class="modal-overlay">
    <div class="modal" style="max-width: 400px;">
      <div class="modal-header">
        <h3 class="modal-title">Admin Authentication</h3>
        <button class="close-modal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="adminPassword">Enter Admin Password</label>
          <input type="password" id="adminPassword" class="form-control">
          <div id="passwordError" class="error-message" style="color: red; display: none;">Incorrect password</div>
        </div>
        <div class="modal-footer">
          <button type="button" id="cancelPasswordBtn" class="btn btn-secondary">Cancel</button>
          <button type="button" id="submitPasswordBtn" class="btn btn-primary">Submit</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Success Modal -->
  <div id="successModal" class="modal-overlay success-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Form Submitted Successfully</h3>
        <button class="close-modal">&times;</button>
      </div>
      <div>
        <p>Your form has been submitted. Your Travel ID is:</p>
        <div class="travel-id" id="successTravelId">CNPO-XX-XX-XXXX</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn close-modal">Close</button>
        <button type="button" id="viewFormBtn" class="btn">View Form</button>
      </div>
    </div>
  </div>

  <!-- Data Summary Modal -->
  <div id="dataSummaryModal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Travel Request Summary</h3>
        <button class="close-modal">&times;</button>
      </div>
      <div class="data-summary-content">
        <div class="summary-item">
          <strong>Travel ID:</strong>
          <span id="summaryTravelId"></span>
        </div>
        <div class="summary-item">
          <strong>Office:</strong>
          <span id="summaryOffice"></span>
        </div>
        <div class="summary-item">
          <strong>Division:</strong>
          <span id="summaryDivision"></span>
        </div>
        <div class="summary-item">
          <strong>Date:</strong>
          <span id="summaryDate"></span>
        </div>
        <div class="summary-item">
          <strong>From:</strong>
          <span id="summaryFrom"></span>
        </div>
        <div class="summary-item">
          <strong>To:</strong>
          <span id="summaryTo"></span>
        </div>
        <div class="summary-item">
          <strong>Time:</strong>
          <span id="summaryTime"></span>
        </div>
        <div class="summary-item">
          <strong>Purpose:</strong>
          <span id="summaryPurpose"></span>
        </div>
        <div class="summary-item">
          <strong>Approved By:</strong>
          <span id="summaryApprovedBy"></span>
        </div>
        <div class="summary-item">
          <strong>Position:</strong>
          <span id="summaryApprovedByPosition"></span>
        </div>
        <div class="summary-item">
          <strong>Employees:</strong>
          <div id="summaryEmployees"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger close-modal">Cancel</button>
        <button type="button" id="generateFormBtn" class="btn">Generate Form</button>
        <button type="button" id="viewFormDetailsBtn" class="btn">View Form Details</button>
      </div>
    </div>
  </div>

  <!-- Delete All Confirmation Modal -->
  <div id="deleteAllConfirmModal" class="modal-overlay">
    <div class="modal" style="max-width: 500px;">
      <div class="modal-header">
        <h3 class="modal-title" style="color: #d32f2f;">⚠️ WARNING: Delete All Data</h3>
        <button class="close-modal">&times;</button>
      </div>
      <div style="padding: 20px;">
        <p style="margin-bottom: 15px; font-weight: bold;">You are about to delete ALL records in the database.</p>
        <p style="margin-bottom: 15px;">This action is permanent and cannot be undone. All official business forms and employee records will be permanently erased.</p>
        <div style="margin: 20px 0; padding: 10px; background-color: #ffebee; border: 1px solid #ffcdd2; border-radius: 4px;">
          <p style="margin-bottom: 10px;">To confirm deletion, type "DELETE" in the box below:</p>
          <input type="text" id="deleteConfirmInput" class="form-control" style="margin-bottom: 10px;" placeholder="Type 'DELETE' here">
          <div id="deleteConfirmError" style="color: #d32f2f; display: none;">Please type DELETE to confirm</div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary close-modal">Cancel</button>
        <button type="button" id="confirmDeleteAllBtn" class="btn btn-danger">Delete All Data</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // DOM Elements
      const obForm = document.getElementById('obForm');
      const employeeTable = document.getElementById('employeeTable').querySelector('tbody');
      const emptyTableMessage = document.getElementById('emptyTableMessage');
      const addEmployeeBtn = document.getElementById('addEmployeeBtn');
      const clearBtn = document.getElementById('clearBtn');
      const retrieveBtn = document.getElementById('retrieveBtn');
      const retrieveId = document.getElementById('retrieveId');
      const alertContainer = document.getElementById('alertContainer');
      
      // Add event listener for settings button
      document.getElementById('settingsBtn').addEventListener('click', function() {
        openModal(settingsModal);
      });
      
      // Form fields
      const officeField = document.getElementById('office');
      const divisionField = document.getElementById('division');
      const dateOfOBField = document.getElementById('dateOfOB');
      const locationFromField = document.getElementById('locationFrom');
      const locationToField = document.getElementById('locationTo');
      const departureTimeField = document.getElementById('departureTime');
      const returnTimeField = document.getElementById('returnTime');
      const purposeField = document.getElementById('purpose');
      const approvedByField = document.getElementById('approvedBy');
      const approvedByPositionField = document.getElementById('approvedByPosition');
      
      // Employee form
      const employeeForm = document.getElementById('employeeForm');
      const employeeNameField = document.getElementById('employeeName');
      const employeePositionField = document.getElementById('employeePosition');
      
      // Settings form
      const settingsForm = document.getElementById('settingsForm');
      const defaultOfficeField = document.getElementById('defaultOffice');
      const defaultOfficeHeadField = document.getElementById('defaultOfficeHead');
      const defaultOfficeHeadPositionField = document.getElementById('defaultOfficeHeadPosition');
      const defaultFromField = document.getElementById('defaultFrom');
      const divisionOptionsField = document.getElementById('divisionOptions');
      
      // Modals
      const addEmployeeModal = document.getElementById('addEmployeeModal');
      const settingsModal = document.getElementById('settingsModal');
      const successModal = document.getElementById('successModal');
      const dataSummaryModal = document.getElementById('dataSummaryModal');
      const successTravelId = document.getElementById('successTravelId');
      const viewFormBtn = document.getElementById('viewFormBtn');
      const viewFormDetailsBtn = document.getElementById('viewFormDetailsBtn');
      const generateFormBtn = document.getElementById('generateFormBtn');
      
      // Summary Elements
      const summaryTravelId = document.getElementById('summaryTravelId');
      const summaryOffice = document.getElementById('summaryOffice');
      const summaryDivision = document.getElementById('summaryDivision');
      const summaryDate = document.getElementById('summaryDate');
      const summaryFrom = document.getElementById('summaryFrom');
      const summaryTo = document.getElementById('summaryTo');
      const summaryTime = document.getElementById('summaryTime');
      const summaryPurpose = document.getElementById('summaryPurpose');
      const summaryApprovedBy = document.getElementById('summaryApprovedBy');
      const summaryApprovedByPosition = document.getElementById('summaryApprovedByPosition');
      const summaryEmployees = document.getElementById('summaryEmployees');
      
      // Modal toggle buttons
      const settingsBtn = document.getElementById('settingsBtn');
      const discardBtn = document.getElementById('discardBtn');
      const closeModalButtons = document.querySelectorAll('.close-modal');
      
      // Store employees
      let employees = [];
      let currentTravelId = '';
      let retrievedFormData = null;
      
      // Fetch settings
      fetchSettings();
      
      // Show/hide empty table message
      function updateTableVisibility() {
        if (employees.length === 0) {
          emptyTableMessage.style.display = 'block';
          employeeTable.style.display = 'none';
        } else {
          emptyTableMessage.style.display = 'none';
          employeeTable.style.display = 'table-row-group';
        }
      }
      
      // Render employee table
      function renderEmployeeTable() {
        employeeTable.innerHTML = '';
        
        employees.forEach((employee, index) => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${employee.name}</td>
            <td>${employee.position}</td>
            <td>
              <button type="button" class="btn btn-danger btn-sm" data-index="${index}">Remove</button>
            </td>
          `;
          employeeTable.appendChild(row);
        });
        
        updateTableVisibility();
        
        // Add event listeners for remove buttons
        document.querySelectorAll('.btn-sm').forEach(button => {
          button.addEventListener('click', function() {
            const index = this.getAttribute('data-index');
            employees.splice(index, 1);
            renderEmployeeTable();
          });
        });
      }
      
      // Show alert message
      function showAlert(message, type) {
        alertContainer.textContent = message;
        alertContainer.className = `alert alert-${type} show`;
        
        setTimeout(() => {
          alertContainer.classList.remove('show');
        }, 5000);
      }
      
      // Fetch settings from API
      function fetchSettings() {
        fetch('/api/settings')
          .then(response => response.json())
          .then(data => {
            // Set default values
            officeField.value = data.office || 'CNPO';
            locationFromField.value = data.location_from || 'Official Station';
            approvedByField.value = data.office_head || 'CHERRY B. MOSATALLA';
            approvedByPositionField.value = data.office_head_position || 'Provincial Head';
            
            // Populate division dropdown
            const divisions = (data.division_options || 'EMPLOYMENT,LR/LS,ASSU,DILP,TUPAD').split(',');
            divisionField.innerHTML = '<option value="">Select Division</option>';
            
            divisions.forEach(division => {
              const option = document.createElement('option');
              option.value = division.trim();
              option.textContent = division.trim();
              divisionField.appendChild(option);
            });
            
            // Set settings form values
            defaultOfficeField.value = data.office || 'CNPO';
            defaultOfficeHeadField.value = data.office_head || 'CHERRY B. MOSATALLA';
            defaultOfficeHeadPositionField.value = data.office_head_position || 'Provincial Head';
            defaultFromField.value = data.location_from || 'Official Station';
            divisionOptionsField.value = data.division_options || 'EMPLOYMENT,LR/LS,ASSU,DILP,TUPAD';
          })
          .catch(error => {
            console.error('Error fetching settings:', error);
            showAlert('Failed to load settings. Using defaults.', 'danger');
          });
      }
      
      // Open modal function
      function openModal(modal) {
        modal.classList.add('active');
      }
      
      // Close modal function
      function closeModal(modal) {
        modal.classList.remove('active');
      }
      
      // Format date to a more readable format
      function formatDate(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
      }

      // Initialize flatpickr for multiple date selection
      const datePickr = flatpickr("#dateOfOB", {
        mode: "multiple",
        dateFormat: "Y-m-d",
        altInput: true,
        altFormat: "F j, Y",
        conjunction: ", "
      });
      
      // Function to get selected dates as array
      function getSelectedDates() {
        return datePickr.selectedDates.map(date => {
          // Use local timezone instead of UTC to prevent date shifting
          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const day = String(date.getDate()).padStart(2, '0');
          return `${year}-${month}-${day}`; // Format as YYYY-MM-DD in local timezone
        });
      }

      // Fill the data summary modal with retrieved data
      function fillDataSummary(data, travelId) {
        summaryTravelId.textContent = travelId;
        summaryOffice.textContent = data.formData.office;
        summaryDivision.textContent = data.formData.division;
        
        // Display multiple dates if available
        if (data.formData.datesOfOB && Array.isArray(data.formData.datesOfOB)) {
          const formattedDates = data.formData.datesOfOB.map(d => formatDate(d)).join(', ');
          summaryDate.textContent = formattedDates;
        } else {
          summaryDate.textContent = formatDate(data.formData.date_of_ob);
        }
        
        summaryFrom.textContent = data.formData.location_from;
        summaryTo.textContent = data.formData.location_to;
        summaryTime.textContent = `${data.formData.departure_time} - ${data.formData.return_time}`;
        summaryPurpose.textContent = data.formData.purpose;
        summaryApprovedBy.textContent = data.formData.approved_by || '';
        summaryApprovedByPosition.textContent = data.formData.approved_by_position || '';
        
        // Display employees
        summaryEmployees.innerHTML = '';
        data.employees.forEach(employee => {
          const employeeDiv = document.createElement('div');
          employeeDiv.textContent = `${employee.name} (${employee.position})`;
          summaryEmployees.appendChild(employeeDiv);
        });
      }

      // Fill form with retrieved data
      function fillForm(data) {
        officeField.value = data.formData.office;
        divisionField.value = data.formData.division;
        
        // Handle multiple dates if available, otherwise use single date
        if (data.formData.datesOfOB && Array.isArray(data.formData.datesOfOB)) {
          datePickr.setDate(data.formData.datesOfOB);
        } else {
          datePickr.setDate(data.formData.date_of_ob || '');
        }
        
        locationFromField.value = data.formData.location_from;
        locationToField.value = data.formData.location_to;
        departureTimeField.value = data.formData.departure_time;
        returnTimeField.value = data.formData.return_time;
        purposeField.value = data.formData.purpose;
        approvedByField.value = data.formData.approved_by || '';
        approvedByPositionField.value = data.formData.approved_by_position || '';
        
        // Set employees
        employees = data.employees;
        renderEmployeeTable();
      }
      
      // Event Listeners
      addEmployeeBtn.addEventListener('click', () => {
        employeeNameField.value = '';
        employeePositionField.value = '';
        openModal(addEmployeeModal);
      });
      
      // Close modals
      closeModalButtons.forEach(button => {
        button.addEventListener('click', () => {
          closeModal(addEmployeeModal);
          closeModal(settingsModal);
          closeModal(successModal);
          closeModal(dataSummaryModal);
        });
      });
      
      // Discard settings changes
      discardBtn.addEventListener('click', () => {
        settingsForm.reset();
        closeModal(settingsModal);
      });
      
      // Submit employee form
      employeeForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const name = employeeNameField.value.trim();
        const position = employeePositionField.value.trim();
        
        if (name && position) {
          employees.push({ name, position });
          renderEmployeeTable();
          closeModal(addEmployeeModal);
        }
      });
      
      // Submit settings form
      settingsForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const office = defaultOfficeField.value.trim();
        const office_head = defaultOfficeHeadField.value.trim();
        const office_head_position = defaultOfficeHeadPositionField.value.trim();
        const location_from = defaultFromField.value.trim();
        const division_options = divisionOptionsField.value.trim();
        
        fetch('/api/settings', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            office,
            office_head,
            office_head_position,
            location_from,
            division_options
          })
        })
          .then(response => response.json())
          .then(data => {
            fetchSettings();
            closeModal(settingsModal);
            showAlert('Settings updated successfully', 'success');
          })
          .catch(error => {
            console.error('Error updating settings:', error);
            showAlert('Failed to update settings', 'danger');
          });
      });
      
      // Clear form data
      clearBtn.addEventListener('click', () => {
        if (confirm('Are you sure you want to clear all data?')) {
          obForm.reset();
          employees = [];
          renderEmployeeTable();
          fetchSettings(); // Restore default values
        }
      });
      
      // Submit form
      obForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (employees.length === 0) {
          showAlert('Please add at least one employee', 'danger');
          return;
        }
        
        // Safely get the purpose value with fallback and validation
        let purposeValue;
        try {
          purposeValue = purposeField.value ? purposeField.value.trim() : '';
          
          // Remove any problematic characters or error messages that might be in the field
          purposeValue = purposeValue.replace(/Uncaught .+?(?:response|channel).+?$/g, '');
          
          // Limit purpose length to avoid database issues
          if (purposeValue.length > 500) {
            purposeValue = purposeValue.substring(0, 500);
          }
          
          // If the purpose is empty or just whitespace after cleanup, use a default
          if (!purposeValue.trim()) {
            purposeValue = "Official Business";
          }
        } catch (error) {
          console.error('Error processing purpose field:', error);
          purposeValue = 'Official Business';
        }
        
        const formData = {
          employees,
          office: officeField.value.trim(),
          division: divisionField.value,
          datesOfOB: getSelectedDates(),
          dateStr: datePickr.altInput.value,
          locationFrom: locationFromField.value.trim(),
          locationTo: locationToField.value.trim(),
          departureTime: departureTimeField.value,
          returnTime: returnTimeField.value,
          purpose: purposeValue,
          approvedBy: approvedByField.value.trim(),
          approvedByPosition: approvedByPositionField.value.trim()
        };
        
        console.log('Submitting form data:', formData);
        console.log('Selected dates:', getSelectedDates());
        
        // Show loading indicator
        showAlert('Submitting form...', 'info');
        
        fetch('/api/submit', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(formData)
        })
          .then(response => {
            if (!response.ok) {
              return response.json()
                .then(errData => {
                  throw new Error(errData.error || 'Network response was not ok');
                })
                .catch(err => {
                  if (err instanceof SyntaxError) {
                    throw new Error('Network response was not ok: ' + response.status);
                  }
                  throw err;
                });
            }
            return response.json();
          })
          .then(data => {
            if (data.success) {
              // Hide any previous alerts
              showAlert('', '');
              
              currentTravelId = data.travelId;
              successTravelId.textContent = currentTravelId;
              openModal(successModal);
              
              // Clear form data after successful submission but keep defaults
              // Use flatpickr clear method instead of direct value assignment
              datePickr.clear();
              locationToField.value = '';
              departureTimeField.value = '';
              returnTimeField.value = '';
              purposeField.value = '';
              employees = [];
              renderEmployeeTable();
              
              // We don't clear office and locationFrom as they're defaults
              // divisionField is reset to default empty selection
              divisionField.value = '';
            }
          })
          .catch(error => {
            console.error('Error submitting form:', error);
            showAlert('Failed to submit form: ' + error.message, 'danger');
          });
      });
      
      // View Form button
      viewFormBtn.addEventListener('click', () => {
        window.open(`/print/${currentTravelId}`, '_blank');
      });
      
      // View Form Details button (from summary modal)
      viewFormDetailsBtn.addEventListener('click', () => {
        if (retrievedFormData) {
          // Fill the form with the retrieved data
          fillForm(retrievedFormData);
          // Close the summary modal
          closeModal(dataSummaryModal);
          showAlert('Form loaded successfully', 'success');
        }
      });
      
      // Generate Form button (from summary modal)
      generateFormBtn.addEventListener('click', () => {
        if (currentTravelId) {
          window.open(`/print/${currentTravelId}`, '_blank');
        }
      });
      
      // Retrieve form
      retrieveBtn.addEventListener('click', () => {
        const travelId = retrieveId.value.trim();
        
        if (!travelId) {
          showAlert('Please enter a Travel ID', 'danger');
          return;
        }
        
        fetch(`/api/retrieve/${travelId}`)
          .then(response => {
            if (!response.ok) {
              if (response.status === 404) {
                throw new Error('Form not found');
              }
              throw new Error('Network response was not ok');
            }
            return response.json();
          })
          .then(data => {
            // Store the retrieved data
            retrievedFormData = data;
            currentTravelId = travelId;
            
            // Fill and show the summary modal
            fillDataSummary(data, travelId);
            openModal(dataSummaryModal);
          })
          .catch(error => {
            console.error('Error retrieving form:', error);
            showAlert(error.message || 'Failed to retrieve form', 'danger');
          });
      });
      
      // Initialize table
      updateTableVisibility();
      
      // Database button functionality
      const databaseBtn = document.getElementById('databaseBtn');
      const passwordModal = document.getElementById('passwordModal');
      const databaseModal = document.getElementById('databaseModal');
      const adminPasswordInput = document.getElementById('adminPassword');
      const submitPasswordBtn = document.getElementById('submitPasswordBtn');
      const cancelPasswordBtn = document.getElementById('cancelPasswordBtn');
      const passwordError = document.getElementById('passwordError');
      const searchDatabase = document.getElementById('searchDatabase');
      const databaseTableBody = document.getElementById('databaseTableBody');
      
      // Add these modals to the closeModalButtons handler
      document.querySelectorAll('#passwordModal .close-modal, #databaseModal .close-modal').forEach(button => {
        button.addEventListener('click', () => {
          closeModal(passwordModal);
          closeModal(databaseModal);
        });
      });
      
      // Database button click - show password modal
      databaseBtn.addEventListener('click', () => {
        adminPasswordInput.value = '';
        passwordError.style.display = 'none';
        openModal(passwordModal);
      });
      
      // Cancel password button
      cancelPasswordBtn.addEventListener('click', () => {
        closeModal(passwordModal);
      });
      
      // Submit password button
      submitPasswordBtn.addEventListener('click', () => {
        const password = adminPasswordInput.value;
        
        if (password === 'dole5admin') {
          // Password correct - close password modal and open database modal
          closeModal(passwordModal);
          loadDatabaseEntries();
          openModal(databaseModal);
        } else {
          // Password incorrect - show error
          passwordError.style.display = 'block';
        }
      });
      
      // Load database entries
      let currentPageNumber = 1;
      let itemsPerPageValue = 10;
      let totalPagesCount = 1;
      let totalEntriesCount = 0;
      
      function loadDatabaseEntries() {
        // Show loading indicator in the table
        databaseTableBody.innerHTML = '<tr><td colspan="8" class="text-center">Loading data...</td></tr>';
        
        fetch(`/api/entries/paginated?page=${currentPageNumber}&limit=${itemsPerPageValue}`)
          .then(response => {
            if (!response.ok) {
              throw new Error('Failed to fetch database entries');
            }
            return response.json();
          })
          .then(data => {
            // Update pagination variables
            totalEntriesCount = data.pagination.total;
            totalPagesCount = data.pagination.totalPages;
            
            // Update pagination UI
            updatePaginationControls();
            
            // Render the table
            renderDatabaseTable(data.entries);
          })
          .catch(error => {
            console.error('Error loading database entries:', error);
            showAlert('Failed to load database entries', 'danger');
            databaseTableBody.innerHTML = '<tr><td colspan="8" class="text-center">Error loading data</td></tr>';
          });
      }
      
      // Update pagination controls
      function updatePaginationControls() {
        // Update page numbers and item counts
        document.getElementById('currentPage').textContent = currentPageNumber;
        document.getElementById('totalPages').textContent = totalPagesCount;
        document.getElementById('totalItems').textContent = totalEntriesCount;
        
        // Calculate current items shown
        const startItem = Math.min(((currentPageNumber - 1) * itemsPerPageValue) + 1, totalEntriesCount);
        const endItem = Math.min(currentPageNumber * itemsPerPageValue, totalEntriesCount);
        document.getElementById('currentItemsShown').textContent = totalEntriesCount === 0 ? '0' : `${startItem}-${endItem}`;
        
        // Enable/disable pagination buttons
        document.getElementById('prevPageBtn').disabled = currentPageNumber <= 1;
        document.getElementById('nextPageBtn').disabled = currentPageNumber >= totalPagesCount;
      }
      
      // Render database table
      function renderDatabaseTable(entries) {
        databaseTableBody.innerHTML = '';
        
        if (entries.length === 0) {
          const row = document.createElement('tr');
          row.innerHTML = '<td colspan="8" class="text-center">No entries found</td>';
          databaseTableBody.appendChild(row);
          return;
        }
        
        entries.forEach(entry => {
          const row = document.createElement('tr');
          row.setAttribute('data-id', entry.travelId);
          
          // Assume each entry has the following structure based on form submission
          row.innerHTML = `
            <td>${entry.travelId}</td>
            <td>${entry.formData.dateOfOB || entry.formData.date_of_ob || ''}</td>
            <td>${getEmployeeNames(entry.employees)}</td>
            <td>${getEmployeePositions(entry.employees)}</td>
            <td>${entry.formData.division}</td>
            <td>${entry.formData.locationTo || entry.formData.location_to || ''}</td>
            <td>${entry.formData.purpose || ''}</td>
            <td>
              <button class="btn btn-sm btn-primary edit-entry" data-id="${entry.travelId}">Edit</button>
              <button class="btn btn-sm btn-danger delete-entry" data-id="${entry.travelId}">Delete</button>
            </td>
          `;
          
          databaseTableBody.appendChild(row);
        });
        
        // Add event listeners for edit and delete buttons
        document.querySelectorAll('.edit-entry').forEach(button => {
          button.addEventListener('click', (e) => {
            const travelId = e.target.getAttribute('data-id');
            startRowEdit(travelId);
          });
        });
        
        document.querySelectorAll('.delete-entry').forEach(button => {
          button.addEventListener('click', (e) => {
            const travelId = e.target.getAttribute('data-id');
            if (confirm(`Are you sure you want to delete entry with Travel ID: ${travelId}?`)) {
              deleteEntry(travelId);
            }
          });
        });
      }
      
      // Helper function to get employee names
      function getEmployeeNames(employees) {
        if (!employees || employees.length === 0) return '';
        return employees.map(emp => emp.name).join(', ');
      }
      
      // Helper function to get employee positions
      function getEmployeePositions(employees) {
        if (!employees || employees.length === 0) return '';
        return employees.map(emp => emp.position).join(', ');
      }
      
      // Start in-place row editing
      function startRowEdit(travelId) {
        // Fetch the entry data
        fetch(`/api/retrieve/${travelId}`)
          .then(response => {
            if (!response.ok) {
              throw new Error('Failed to fetch entry details');
            }
            return response.json();
          })
          .then(data => {
            // Get the row to edit
            const row = document.querySelector(`tr[data-id="${travelId}"]`);
            if (!row) return;
            
            // Store original data for potential cancellation
            row.setAttribute('data-original', JSON.stringify(data));
            
            // Format date string for display in the edit form
            let dateDisplay = '';
            if (data.formData.datesOfOB && Array.isArray(data.formData.datesOfOB)) {
              dateDisplay = data.formData.datesOfOB.join(',');
            } else {
              dateDisplay = data.formData.dateOfOB || data.formData.date_of_ob || '';
            }
            
            // Replace row with editable fields
            row.innerHTML = `
              <td>${travelId}</td>
              <td><input type="text" class="form-control" id="edit-date" placeholder="Select date(s)"></td>
              <td colspan="2">
                <div id="editEmployeesContainer">
                  ${data.employees.map((emp, idx) => `
                    <div class="edit-employee-row" style="display: flex; margin-bottom: 5px;">
                      <input type="text" class="form-control" value="${emp.name}" placeholder="Name" style="flex: 1; margin-right: 5px;">
                      <input type="text" class="form-control" value="${emp.position}" placeholder="Position" style="flex: 1; margin-right: 5px;">
                      <button type="button" class="btn btn-sm btn-danger remove-employee" data-idx="${idx}">-</button>
                    </div>
                  `).join('')}
                  <button type="button" class="btn btn-sm btn-primary" id="addEditEmployeeBtn">+ Add Employee</button>
                </div>
              </td>
              <td>
                <select class="form-control" id="edit-division">
                  ${divisionField.innerHTML}
                </select>
              </td>
              <td><input type="text" class="form-control" value="${data.formData.locationTo || data.formData.location_to || ''}" id="edit-destination"></td>
              <td><textarea class="form-control" id="edit-purpose">${data.formData.purpose || ''}</textarea></td>
              <td>
                <div class="form-group" style="margin-bottom: 5px;">
                  <input type="text" class="form-control" id="edit-approved-by" placeholder="Approved By" value="${data.formData.approvedBy || data.formData.approved_by || ''}">
                </div>
                <div class="form-group" style="margin-bottom: 5px;">
                  <input type="text" class="form-control" id="edit-approved-by-position" placeholder="Position" value="${data.formData.approvedByPosition || data.formData.approved_by_position || ''}">
                </div>
                <button class="btn btn-sm btn-success save-edit" data-id="${travelId}">Save</button>
                <button class="btn btn-sm btn-secondary cancel-edit" data-id="${travelId}">Cancel</button>
              </td>
            `;
            
            // Initialize flatpickr for multiple date selection in edit mode
            const editDatePickr = flatpickr(row.querySelector("#edit-date"), {
              mode: "multiple",
              dateFormat: "Y-m-d",
              altInput: true,
              altFormat: "F j, Y",
              conjunction: ", "
            });
            
            // Set dates if available
            if (data.formData.datesOfOB && Array.isArray(data.formData.datesOfOB)) {
              editDatePickr.setDate(data.formData.datesOfOB);
            } else if (data.formData.date_of_ob) {
              editDatePickr.setDate(data.formData.date_of_ob);
            }
            
            // Set division value
            const divSelect = row.querySelector('#edit-division');
            divSelect.value = data.formData.division;
            
            // Add event listeners for the new buttons
            row.querySelector('.save-edit').addEventListener('click', () => saveRowEdit(travelId, row, editDatePickr));
            row.querySelector('.cancel-edit').addEventListener('click', () => cancelRowEdit(travelId, row));
            
            // Add employee button
            row.querySelector('#addEditEmployeeBtn').addEventListener('click', () => {
              const container = row.querySelector('#editEmployeesContainer');
              const newRow = document.createElement('div');
              newRow.className = 'edit-employee-row';
              newRow.style = 'display: flex; margin-bottom: 5px;';
              newRow.innerHTML = `
                <input type="text" class="form-control" placeholder="Name" style="flex: 1; margin-right: 5px;">
                <input type="text" class="form-control" placeholder="Position" style="flex: 1; margin-right: 5px;">
                <button type="button" class="btn btn-sm btn-danger remove-employee">-</button>
              `;
              
              // Insert before the Add button
              container.insertBefore(newRow, document.getElementById('addEditEmployeeBtn'));
              
              // Add remove event listener
              newRow.querySelector('.remove-employee').addEventListener('click', function() {
                this.parentElement.remove();
              });
            });
            
            // Add remove employee event listeners
            row.querySelectorAll('.remove-employee').forEach(btn => {
              btn.addEventListener('click', function() {
                this.parentElement.remove();
              });
            });
          })
          .catch(error => {
            console.error('Error fetching entry details for editing:', error);
            showAlert('Failed to load entry details for editing', 'danger');
          });
      }
      
      // Save row edits
      function saveRowEdit(travelId, row, datePickr) {
        // Gather edited data
        const division = row.querySelector('#edit-division').value;
        const locationTo = row.querySelector('#edit-destination').value;
        const purpose = row.querySelector('#edit-purpose').value;
        const approvedBy = row.querySelector('#edit-approved-by').value;
        const approvedByPosition = row.querySelector('#edit-approved-by-position').value;
        
        // Get selected dates using local timezone to prevent date shifting
        const datesOfOB = datePickr.selectedDates.map(date => {
          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const day = String(date.getDate()).padStart(2, '0');
          return `${year}-${month}-${day}`; // Format as YYYY-MM-DD in local timezone
        });
        
        // Gather employees
        const employeeRows = row.querySelectorAll('.edit-employee-row');
        const employees = [];
        
        employeeRows.forEach(empRow => {
          const inputs = empRow.querySelectorAll('input');
          const name = inputs[0].value.trim();
          const position = inputs[1].value.trim();
          
          if (name && position) {
            employees.push({ name, position });
          }
        });
        
        if (employees.length === 0) {
          showAlert('Please add at least one employee', 'danger');
          return;
        }
        
        // Get original data to preserve unchanged fields
        const originalData = JSON.parse(row.getAttribute('data-original'));
        
        // Prepare the updated data
        const formData = {
          ...originalData.formData,
          datesOfOB: datesOfOB,
          division: division,
          location_to: locationTo,
          purpose: purpose,
          approved_by: approvedBy,
          approved_by_position: approvedByPosition
        };
        
        // Send update to server
        fetch(`/api/update/${travelId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            formData,
            employees
          })
        })
          .then(response => {
            if (!response.ok) {
              throw new Error('Failed to update entry');
            }
            return response.json();
          })
          .then(data => {
            showAlert('Entry updated successfully', 'success');
            // Reload database entries to show updated data
            loadDatabaseEntries();
          })
          .catch(error => {
            console.error('Error updating entry:', error);
            showAlert('Failed to update entry', 'danger');
          });
      }
      
      // Cancel row edit
      function cancelRowEdit(travelId, row) {
        // Reload database entries to restore original view
        loadDatabaseEntries();
      }

      // Edit entry (original function kept for reference but not used anymore)
      function editEntry(travelId) {
        fetch(`/api/retrieve/${travelId}`)
          .then(response => {
            if (!response.ok) {
              throw new Error('Failed to fetch entry details');
            }
            return response.json();
          })
          .then(data => {
            // Fill the form with the retrieved data
            fillForm(data);
            currentTravelId = travelId;
            // Close the database modal
            closeModal(databaseModal);
            showAlert('Form loaded for editing', 'success');
          })
          .catch(error => {
            console.error('Error fetching entry details:', error);
            showAlert('Failed to load entry details', 'danger');
          });
      }
      
      // Delete entry
      function deleteEntry(travelId) {
        fetch(`/api/delete/${travelId}`, {
          method: 'DELETE'
        })
          .then(response => {
            if (!response.ok) {
              throw new Error('Failed to delete entry');
            }
            return response.json();
          })
          .then(data => {
            showAlert('Entry deleted successfully', 'success');
            // Reload database entries
            loadDatabaseEntries();
          })
          .catch(error => {
            console.error('Error deleting entry:', error);
            showAlert('Failed to delete entry', 'danger');
          });
      }
      
      // Search functionality
      let searchTimeout;
      searchDatabase.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        
        // Clear any existing timeout
        clearTimeout(searchTimeout);
        
        // Set a new timeout to prevent too many requests while typing
        searchTimeout = setTimeout(() => {
          // For client-side filtering:
          if (searchTerm.length === 0) {
            // If search term is cleared, just reload with pagination
            currentPageNumber = 1;
            loadDatabaseEntries();
            return;
          }
          
          // For simple client-side filtering using the currently displayed data
          const tableRows = databaseTableBody.querySelectorAll('tr');
          let visibleCount = 0;
          
          tableRows.forEach(row => {
            const text = row.textContent.toLowerCase();
            if (text.includes(searchTerm)) {
              row.style.display = '';
              visibleCount++;
            } else {
              row.style.display = 'none';
            }
          });
          
          // Update the pagination info to reflect the search results
          document.getElementById('currentItemsShown').textContent = visibleCount;
          
          // Disable pagination during search
          prevPageBtn.disabled = true;
          nextPageBtn.disabled = true;
        }, 300); // Debounce for 300ms
      });
      
      // Enter key on password input
      adminPasswordInput.addEventListener('keyup', (e) => {
        if (e.key === 'Enter') {
          submitPasswordBtn.click();
        }
      });
      
      // Pagination functionality
      const prevPageBtn = document.getElementById('prevPageBtn');
      const nextPageBtn = document.getElementById('nextPageBtn');
      const itemsPerPage = document.getElementById('itemsPerPage');
      
      // Previous page button
      prevPageBtn.addEventListener('click', () => {
        if (currentPageNumber > 1) {
          currentPageNumber--;
          loadDatabaseEntries();
        }
      });
      
      // Next page button
      nextPageBtn.addEventListener('click', () => {
        if (currentPageNumber < totalPagesCount) {
          currentPageNumber++;
          loadDatabaseEntries();
        }
      });
      
      // Items per page dropdown
      itemsPerPage.addEventListener('change', () => {
        itemsPerPageValue = parseInt(itemsPerPage.value);
        currentPageNumber = 1; // Reset to first page on items per page change
        loadDatabaseEntries();
      });
      
      // Export to CSV functionality
      document.getElementById('exportCSVBtn').addEventListener('click', function() {
        exportTableToCSV();
      });
      
      // Export to JSON functionality
      document.getElementById('exportJSONBtn').addEventListener('click', function() {
        exportDataToJSON();
      });
      
      // Handle JSON import
      document.getElementById('importJSONFile').addEventListener('change', function(e) {
        importDataFromJSON(e);
      });
      
      // Function to export data to JSON
      function exportDataToJSON() {
        fetch('/api/export-data')
          .then(response => {
            if (!response.ok) {
              throw new Error('Failed to export data');
            }
            return response.blob();
          })
          .then(blob => {
            // Create download link
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.setAttribute('download', `ob-data-export_${new Date().toISOString().split('T')[0]}.json`);
            document.body.appendChild(link);
            
            // Trigger download
            link.click();
            
            // Clean up
            window.URL.revokeObjectURL(url);
            document.body.removeChild(link);
            
            showAlert('Data exported successfully!', 'success');
          })
          .catch(error => {
            console.error('Error exporting data:', error);
            showAlert('Failed to export data: ' + error.message, 'danger');
          });
      }
      
      // Function to import data from JSON
      function importDataFromJSON(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        // Show loading indicator
        showAlert('Importing data, please wait...', 'info');
        
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const data = JSON.parse(e.target.result);
            
            // Send the data to the server
            fetch('/api/import-data', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(data)
            })
            .then(response => {
              if (!response.ok) {
                return response.json().then(err => {
                  throw new Error(err.error || 'Failed to import data');
                });
              }
              return response.json();
            })
            .then(result => {
              showAlert(`Data imported successfully! ${result.forms} forms, ${result.employees} employees.`, 'success');
              // Reload the database entries
              loadDatabaseEntries();
            })
            .catch(error => {
              console.error('Error importing data:', error);
              showAlert('Failed to import data: ' + error.message, 'danger');
            });
          } catch (error) {
            console.error('Error parsing JSON file:', error);
            showAlert('Invalid JSON file: ' + error.message, 'danger');
          }
          
          // Reset the file input
          e.target.value = '';
        };
        
        reader.onerror = function() {
          showAlert('Error reading file', 'danger');
          e.target.value = '';
        };
        
        reader.readAsText(file);
      }
      
      // Function to export table data to CSV
      function exportTableToCSV() {
        // Get all data (not just current page)
        fetch('/api/entries')
          .then(response => {
            if (!response.ok) {
              throw new Error('Failed to fetch database entries');
            }
            return response.json();
          })
          .then(data => {
            // Create CSV content
            let csvContent = 'Travel ID,Date,Name,Position,Division,Destination,Purpose,Approved By\n';
            
            data.forEach(entry => {
              const travelId = entry.travelId;
              
              // Format date(s)
              let dateStr = '';
              if (entry.formData.datesOfOB && Array.isArray(entry.formData.datesOfOB)) {
                dateStr = entry.formData.datesOfOB.join('; ');
              } else {
                dateStr = entry.formData.dateOfOB || entry.formData.date_of_ob || '';
              }
              
              const names = getEmployeeNames(entry.employees);
              const positions = getEmployeePositions(entry.employees);
              const division = entry.formData.division || '';
              const destination = entry.formData.locationTo || entry.formData.location_to || '';
              const purpose = entry.formData.purpose || '';
              const approvedBy = entry.formData.approvedBy || entry.formData.approved_by || '';
              
              // Escape fields with commas by wrapping in quotes
              const escapeCsv = (field) => {
                // Replace any existing quotes with double quotes and wrap in quotes if contains comma or quotes
                const escaped = field.toString().replace(/"/g, '""');
                return (escaped.includes(',') || escaped.includes('"')) ? `"${escaped}"` : escaped;
              };
              
              // Add row to CSV
              csvContent += [
                escapeCsv(travelId),
                escapeCsv(dateStr),
                escapeCsv(names),
                escapeCsv(positions),
                escapeCsv(division),
                escapeCsv(destination),
                escapeCsv(purpose),
                escapeCsv(approvedBy)
              ].join(',') + '\n';
            });
            
            // Create download link
            const encodedUri = encodeURI('data:text/csv;charset=utf-8,' + csvContent);
            const link = document.createElement('a');
            link.setAttribute('href', encodedUri);
            link.setAttribute('download', `official_business_data_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            
            // Trigger download
            link.click();
            
            // Clean up
            document.body.removeChild(link);
          })
          .catch(error => {
            console.error('Error exporting to CSV:', error);
            showAlert('Failed to export data to CSV', 'danger');
          });
      }
      
      // Delete all data functionality
      const deleteAllConfirmModal = document.getElementById('deleteAllConfirmModal');
      const deleteConfirmInput = document.getElementById('deleteConfirmInput');
      const deleteConfirmError = document.getElementById('deleteConfirmError');
      const confirmDeleteAllBtn = document.getElementById('confirmDeleteAllBtn');
      
      document.getElementById('deleteAllBtn').addEventListener('click', function() {
        // Open confirmation modal
        deleteConfirmInput.value = '';
        deleteConfirmError.style.display = 'none';
        openModal(deleteAllConfirmModal);
      });
      
      // Add close modal functionality for delete confirmation modal
      deleteAllConfirmModal.querySelectorAll('.close-modal').forEach(button => {
        button.addEventListener('click', () => {
          closeModal(deleteAllConfirmModal);
        });
      });
      
      // Confirm delete all button
      confirmDeleteAllBtn.addEventListener('click', function() {
        const confirmText = deleteConfirmInput.value.trim();
        
        if (confirmText !== 'DELETE') {
          deleteConfirmError.style.display = 'block';
          return;
        }
        
        // Hide error and close modal
        deleteConfirmError.style.display = 'none';
        closeModal(deleteAllConfirmModal);
        
        // Call delete all function
        deleteAllData();
      });
      
      // Allow Enter key in delete confirmation input
      deleteConfirmInput.addEventListener('keyup', (e) => {
        if (e.key === 'Enter') {
          confirmDeleteAllBtn.click();
        }
      });
      
      // Function to delete all data
      function deleteAllData() {
        fetch('/api/delete-all', {
          method: 'DELETE'
        })
          .then(response => {
            if (!response.ok) {
              throw new Error('Failed to delete all data');
            }
            return response.json();
          })
          .then(data => {
            showAlert('All data has been deleted successfully', 'success');
            // Reset pagination to page 1
            currentPageNumber = 1;
            // Reload database entries (should be empty now)
            loadDatabaseEntries();
          })
          .catch(error => {
            console.error('Error deleting all data:', error);
            showAlert('Failed to delete all data: ' + error.message, 'danger');
          });
      }
    });
  </script>
</body>
</html> 